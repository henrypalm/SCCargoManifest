<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SC Cargo Manifest</title>
  <link rel="icon" href="logo.ico" type="image/x-icon" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: white;
      margin: 0;
      padding-bottom: 120px;
    }

    h1 {
      text-align: center;
      color: gold;
      padding-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #444;
      text-align: left;
    }

    input, select {
      background-color: #222;
      color: white;
      border: 1px solid #444;
      padding: 0.3rem;
      border-radius: 4px;
      width: 100%;
    }

    .highlighted-text {
      color: white;
      background-color: black;
      padding: 0 0.2em;
    }

    #exportBox {
      position: sticky;
      bottom: 0;
      background: #222;
      padding: 1em;
      border-top: 2px solid #555;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1em;
      z-index: 999;
    }

    details {
      margin: 1rem;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 0.5rem;
    }

    summary {
      font-weight: bold;
      font-size: 1.2rem;
      cursor: pointer;
      color: #0ff;
    }

    #grandTotalDisplay {
      font-size: 1.2rem;
      font-weight: bold;
      color: gold;
    }

    #manifestTitle {
      width: 50%;
      margin: 1rem auto;
      display: block;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <input type="text" id="manifestTitle" placeholder="Enter manifest title..." />
  <h1 id="manifestTitleDisplay">Cargo Manifest Calculator</h1>

  <details open>
    <summary>Ship Mining</summary>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Location</th>
          <th>Unit Price<br>(choose size)</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="shipMiningBody"></tbody>
    </table>
  </details>

  <details open>
    <summary>Handheld and Light Ship Mining</summary>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Location</th>
          <th>Unit Price<br>(choose size)</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="handMiningBody"></tbody>
    </table>
  </details>

  <details open>
    <summary>Salvage</summary>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Location</th>
          <th>Unit Price<br>(choose size)</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="salvageBody"></tbody>
    </table>
  </details>

  <div id="exportBox">
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="exportTXT()">Export TXT</button>
    <div id="grandTotalDisplay">Total: 0 aUEC</div>
  </div>

  <script src="itemPrices.js"></script>
  <script src="itemColors.js"></script>
  <script>
    const shipMiningBody = document.getElementById("shipMiningBody");
    const handMiningBody = document.getElementById("handMiningBody");
    const salvageBody = document.getElementById("salvageBody");

    function updateGrandTotal() {
      let total = 0;
      [shipMiningBody, handMiningBody, salvageBody].forEach(body => {
        Array.from(body.children).forEach(row => {
          const value = parseFloat(row.children[4].querySelector("span").textContent.replace(/,/g, ""));
          total += isNaN(value) ? 0 : value;
        });
      });
      document.getElementById("grandTotalDisplay").textContent = "Total: " + total.toLocaleString() + " aUEC";
    }

    function createCargoRow(item, targetBody, itemPricesForItem) {
      const row = document.createElement("tr");
      row.style.backgroundColor = itemColors?.[item] || "#1e1e1e";

      row.innerHTML = `
        <td><span class="highlighted-text">${item}</span></td>
        <td><input type="number" min="0" /></td>
        <td><select></select></td>
        <td><span class="highlighted-text">0</span><br/><select>
          <option value="scu">per SCU</option>
          <option value="cscu">per CSCU</option>
          <option value="mscu">per MSCU</option>
        </select></td>
        <td><span class="highlighted-text">0</span></td>
      `;

      const quantityInput = row.querySelector("input");
      const locationSelect = row.children[2].querySelector("select");
      const scuTypeSelect = row.children[3].querySelector("select");
      const unitPriceSpan = row.children[3].querySelector("span");
      const totalSpan = row.children[4].querySelector("span");

      Object.keys(itemPricesForItem).forEach(location => {
        const opt = document.createElement("option");
        opt.value = location;
        opt.textContent = location;
        locationSelect.appendChild(opt);
      });

      function updateRow() {
        const location = locationSelect.value;
        const scuType = scuTypeSelect.value;
        const unitPrice = itemPricesForItem?.[location]?.[scuType] || 0;
        const qty = parseFloat(quantityInput.value) || 0;
        const total = qty * unitPrice;

        unitPriceSpan.textContent = unitPrice.toLocaleString();
        totalSpan.textContent = total.toLocaleString();
        updateGrandTotal();
      }

      quantityInput.addEventListener("input", updateRow);
      locationSelect.addEventListener("change", updateRow);
      scuTypeSelect.addEventListener("change", updateRow);

      targetBody.appendChild(row);
      updateRow();
    }

    const categories = {
      "Ship Mining": shipMiningBody,
      "Handheld and Light Ship Mining": handMiningBody,
      "Salvage": salvageBody
    };

    window.onload = () => {
      for (const [category, body] of Object.entries(categories)) {
        if (!itemPrices[category]) continue;
        Object.keys(itemPrices[category]).forEach(item => {
          createCargoRow(item, body, itemPrices[category][item]);
        });
      }

      document.getElementById("manifestTitle").addEventListener("input", () => {
        const title = document.getElementById("manifestTitle").value;
        document.getElementById("manifestTitleDisplay").textContent = title || "Cargo Manifest Calculator";
      });
    };

    function exportTXT() {
      const title = document.getElementById("manifestTitle").value || "Cargo Manifest";
      let txt = `Title: ${title}\n\n`;
      let total = 0;

      for (const [category, body] of Object.entries(categories)) {
        const rows = Array.from(body.children);
        if (rows.length === 0) continue;

        txt += `Category: ${category}\n`;

        rows.forEach(row => {
          const item = row.children[0].innerText.trim();
          const qty = row.children[1].querySelector("input").value || "0";
          const location = row.children[2].querySelector("select").value;
          const unitPrice = row.children[3].querySelector("span").textContent;
          const totalValue = row.children[4].querySelector("span").textContent;

          txt += `${item} | Qty: ${qty} | Location: ${location} | Unit Price: ${unitPrice} | Total: ${totalValue}\n`;
          total += parseFloat(totalValue.replace(/,/g, "")) || 0;
        });

        txt += "\n";
      }

      txt += `Grand Total: ${total.toLocaleString()}\n`;
      downloadFile(txt, `${title.replace(/\s+/g, "_")}_${timestamp()}.txt`);
    }

    function exportCSV() {
      // CSV format identical to TXT per your instruction
      exportTXT(); // just reuses exportTXT()
    }

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function timestamp() {
      return new Date().toISOString().slice(0, 16).replace(/[:T]/g, "-");
    }
  </script>
</body>
</html>
